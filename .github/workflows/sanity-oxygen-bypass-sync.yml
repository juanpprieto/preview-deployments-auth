name: Sync Oxygen auth to Sanity

on:
  issue_comment:
    types: [created, edited]

permissions:
  contents: read
  pull-requests: read

jobs:
  sync-token:
    name: Extract and sync token
    runs-on: ubuntu-latest
    if: >
      github.event.comment.user.login == 'shopify[bot]' &&
      contains(github.event.comment.body, 'Successful') &&
      github.event.issue.pull_request

    steps:
      - name: Log trigger
        run: |
          echo "=== issue_comment event fired for shopify[bot] ==="
          echo "PR: #${{ github.event.issue.number }}"
          echo "Comment author: ${{ github.event.comment.user.login }}"

      - name: Resolve target branch and environment
        id: env
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_JSON=$(gh api repos/${{ github.repository }}/pulls/${{ github.event.issue.number }})
          TARGET_BRANCH=$(echo "$PR_JSON" | jq -r '.base.ref')
          echo "target_branch=$TARGET_BRANCH" >> $GITHUB_OUTPUT
          echo "Target branch: $TARGET_BRANCH"

          case "$TARGET_BRANCH" in
            main)
              echo "dataset=production" >> $GITHUB_OUTPUT
              echo "doc_id=oxygen-bypass.production" >> $GITHUB_OUTPUT
              echo "env_name=Production" >> $GITHUB_OUTPUT
              ;;
            staging)
              echo "dataset=staging" >> $GITHUB_OUTPUT
              echo "doc_id=oxygen-bypass.staging" >> $GITHUB_OUTPUT
              echo "env_name=Staging" >> $GITHUB_OUTPUT
              ;;
            dev)
              echo "dataset=dev" >> $GITHUB_OUTPUT
              echo "doc_id=oxygen-bypass.dev" >> $GITHUB_OUTPUT
              echo "env_name=Dev" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "WARNING: Unknown target branch '$TARGET_BRANCH', defaulting to staging"
              echo "dataset=staging" >> $GITHUB_OUTPUT
              echo "doc_id=oxygen-bypass.staging" >> $GITHUB_OUTPUT
              echo "env_name=Staging" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Extract token
        id: extract
        shell: bash
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          DEPLOY_URL=$(echo "$COMMENT_BODY" | grep -o 'https://[a-z0-9-]*\.myshopify\.dev' | head -1)
          echo "deploy_url=$DEPLOY_URL" >> $GITHUB_OUTPUT
          echo "Extracted URL: $DEPLOY_URL"

          AUTH_TOKEN=$(echo "$COMMENT_BODY" | grep -o '_auth=[^)]*' | head -1 | sed 's/_auth=//')
          echo "::add-mask::$AUTH_TOKEN"
          echo "auth_token=$AUTH_TOKEN" >> $GITHUB_OUTPUT
          echo "Token length: ${#AUTH_TOKEN}"

          PAYLOAD=$(echo "$AUTH_TOKEN" | cut -d. -f2)
          MOD=$((${#PAYLOAD} % 4))
          if [ $MOD -eq 2 ]; then PAYLOAD="${PAYLOAD}=="; elif [ $MOD -eq 3 ]; then PAYLOAD="${PAYLOAD}="; fi
          TOKEN_KIND=$(echo "$PAYLOAD" | base64 -d 2>/dev/null | python3 -c "import sys,json; print(json.load(sys.stdin).get('kind','UNKNOWN'))" 2>/dev/null || echo "UNKNOWN")
          echo "token_kind=$TOKEN_KIND" >> $GITHUB_OUTPUT
          echo "Token kind: $TOKEN_KIND"

      - name: Verify token works
        env:
          DEPLOY_URL: ${{ steps.extract.outputs.deploy_url }}
          AUTH_TOKEN: ${{ steps.extract.outputs.auth_token }}
        run: |
          if [ -z "$DEPLOY_URL" ] || [ -z "$AUTH_TOKEN" ]; then
            echo "ERROR: Missing URL or token"
            exit 1
          fi
          STATUS=$(curl -sS -o /dev/null -w "%{http_code}" "${DEPLOY_URL}?_auth=${AUTH_TOKEN}")
          echo "Token verification: HTTP $STATUS"
          if [ "$STATUS" != "200" ]; then
            echo "WARNING: Token did not return 200"
          fi

      - name: Save as artifact
        env:
          DEPLOY_URL: ${{ steps.extract.outputs.deploy_url }}
          AUTH_TOKEN: ${{ steps.extract.outputs.auth_token }}
          TOKEN_KIND: ${{ steps.extract.outputs.token_kind }}
          SANITY_DATASET: ${{ steps.env.outputs.dataset }}
        run: |
          mkdir -p /tmp/oxygen-bypass
          cat > /tmp/oxygen-bypass/token.json << ARTIFACT_EOF
          {
            "deploymentUrl": "$DEPLOY_URL",
            "authToken": "$AUTH_TOKEN",
            "tokenKind": "$TOKEN_KIND",
            "dataset": "$SANITY_DATASET",
            "pr": ${{ github.event.issue.number }},
            "extractedAt": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          ARTIFACT_EOF
          echo "Artifact contents:"
          cat /tmp/oxygen-bypass/token.json

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: oxygen-bypass-token
          path: /tmp/oxygen-bypass/token.json
          retention-days: 90

      - name: Patch Sanity bypass document
        env:
          DEPLOY_URL: ${{ steps.extract.outputs.deploy_url }}
          AUTH_TOKEN: ${{ steps.extract.outputs.auth_token }}
          TOKEN_KIND: ${{ steps.extract.outputs.token_kind }}
          TARGET_BRANCH: ${{ steps.env.outputs.target_branch }}
          SANITY_DATASET: ${{ steps.env.outputs.dataset }}
          SANITY_DOC_ID: ${{ steps.env.outputs.doc_id }}
          SANITY_ENV_NAME: ${{ steps.env.outputs.env_name }}
          SANITY_WRITE_TOKEN: ${{ secrets.SANITY_API_WRITE_TOKEN }}
        run: |
          if [ -z "$SANITY_WRITE_TOKEN" ]; then
            echo "WARNING: SANITY_API_WRITE_TOKEN secret not set, skipping Sanity patch"
            exit 0
          fi

          echo "Patching doc '$SANITY_DOC_ID' in dataset '$SANITY_DATASET'"

          PAYLOAD=$(jq -n \
            --arg id "$SANITY_DOC_ID" \
            --arg url "$DEPLOY_URL" \
            --arg token "$AUTH_TOKEN" \
            --arg kind "$TOKEN_KIND" \
            --arg branch "$TARGET_BRANCH" \
            --arg name "$SANITY_ENV_NAME" \
            --arg ts "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            '{mutations: [{createOrReplace: {
              _id: $id,
              _type: "sanity.oxygenProtectionBypass",
              name: $name,
              deploymentUrl: $url,
              authToken: $token,
              branch: $branch,
              tokenKind: $kind,
              updatedAt: $ts
            }}]}')

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://sx997gpv.api.sanity.io/v2021-06-07/data/mutate/${SANITY_DATASET}" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $SANITY_WRITE_TOKEN" \
            -d "$PAYLOAD")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          echo "Sanity API response: HTTP $HTTP_CODE"
          echo "$BODY" | python3 -m json.tool 2>/dev/null || echo "$BODY"

          if [ "$HTTP_CODE" != "200" ]; then
            echo "ERROR: Failed to patch Sanity document"
            exit 1
          fi
          echo "Successfully updated $SANITY_DOC_ID in dataset $SANITY_DATASET"

      - name: Summary
        env:
          DEPLOY_URL: ${{ steps.extract.outputs.deploy_url }}
          TOKEN_KIND: ${{ steps.extract.outputs.token_kind }}
          SANITY_DATASET: ${{ steps.env.outputs.dataset }}
          SANITY_DOC_ID: ${{ steps.env.outputs.doc_id }}
        run: |
          echo "=== Sync Summary ==="
          echo "PR: #${{ github.event.issue.number }}"
          echo "Deploy URL: $DEPLOY_URL"
          echo "Token kind: $TOKEN_KIND"
          echo "Dataset: $SANITY_DATASET"
          echo "Doc: $SANITY_DOC_ID patched"

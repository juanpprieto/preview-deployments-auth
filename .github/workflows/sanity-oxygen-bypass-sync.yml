name: Sync Oxygen auth to Sanity

on:
  issue_comment:
    types: [created, edited]

permissions:
  contents: read
  pull-requests: read

jobs:
  sync-token:
    name: Extract and sync token
    runs-on: ubuntu-latest
    if: >
      github.event.comment.user.login == 'shopify[bot]' &&
      contains(github.event.comment.body, 'âœ… Successful') &&
      github.event.issue.pull_request

    steps:
      - name: Log trigger
        run: |
          echo "=== issue_comment event fired for shopify[bot] ==="
          echo "PR: #${{ github.event.issue.number }}"
          echo "Comment author: ${{ github.event.comment.user.login }}"
          echo "Comment author type: ${{ github.event.comment.user.type }}"
          echo "Body preview: $(echo '${{ github.event.comment.body }}' | head -c 200)"

      - name: Extract token
        id: extract
        run: |
          BODY='${{ github.event.comment.body }}'
          DEPLOY_URL=$(echo "$BODY" | sed -n 's/.*(\(https:\/\/[a-z0-9-]*\.myshopify\.dev\)?.*/\1/p' | head -1)
          AUTH_TOKEN=$(echo "$BODY" | sed -n 's/.*_auth=\([^)]*\).*/\1/p' | head -1)
          echo "deploy_url=$DEPLOY_URL" >> $GITHUB_OUTPUT
          echo "::add-mask::$AUTH_TOKEN"
          echo "auth_token=$AUTH_TOKEN" >> $GITHUB_OUTPUT
          echo "Extracted URL: $DEPLOY_URL"
          echo "Token length: ${#AUTH_TOKEN}"
